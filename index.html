<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SUPER SALES KART : 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --kart-blue: #009dfd;
            --kart-red: #ea0012;
            --kart-yellow: #fff300;
            --kart-green: #37d300;
            --kart-dark: #121212;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.4);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #2c3e50;
            color: #333;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overscroll-behavior: none;
        }

        .kart-frame {
            width: 100%;
            max-width: 480px;
            height: 100dvh;
            max-height: 900px;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%);
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 4px solid #fff;
            border-radius: 24px;
        }

        .road-bg {
            position: absolute;
            bottom: -20%; left: -50%; width: 200%; height: 60%;
            background-color: #444;
            background-image: 
                linear-gradient(90deg, transparent 49%, #fff 50%, transparent 51%),
                repeating-linear-gradient(0deg, transparent, transparent 20px, rgba(255,255,255,0.1) 21px, rgba(255,255,255,0.1) 40px);
            transform: perspective(500px) rotateX(60deg);
            animation: roadMove 1s linear infinite;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }
        
        .road-bg::after {
            content: '';
            position: absolute;
            top: 0; left: 50%; width: 10px; height: 100%;
            background: repeating-linear-gradient(to bottom, #fff, #fff 40px, transparent 40px, transparent 80px);
            transform: translateX(-50%);
        }

        @keyframes roadMove {
            from { background-position: 0 0; }
            to { background-position: 0 80px; }
        }

        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            z-index: 50;
            background: rgba(0, 157, 253, 0.4);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(255,255,255,0.5);
            color: white;
        }
        .lap-badge {
            font-family: 'Fredoka', sans-serif;
            background: var(--kart-red);
            padding: 2px 12px;
            border-radius: 20px;
            font-weight: 700;
            box-shadow: 0 4px 0 #990000;
        }

        .scene {
            flex: 1;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
            scrollbar-width: none;
            width: 100%;
        }
        .scene::-webkit-scrollbar { display: none; }
        .center-scene { justify-content: center; }

        .intro-logo {
            font-family: 'Fredoka', sans-serif;
            font-size: 44px;
            line-height: 1;
            font-weight: 700;
            color: #fff;
            text-align: center;
            text-shadow: 0 4px 0 var(--kart-blue), 0 8px 0 var(--kart-dark);
            transform: skewY(-5deg) rotate(-2deg);
            margin-bottom: 30px;
        }
        .logo-sub {
            background: var(--kart-yellow);
            color: #000;
            padding: 8px 24px;
            border-radius: 50px;
            font-weight: 900;
            display: inline-block;
            box-shadow: 0 5px 0 #e6a700;
            transform: skewY(-5deg);
            margin-bottom: 50px;
        }
        
        .kart-btn {
            background: linear-gradient(to bottom, #ff5e3a 0%, #ff2a00 100%);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50px;
            color: white;
            font-family: 'Fredoka', sans-serif;
            font-size: 24px;
            font-weight: 700;
            padding: 16px 60px;
            box-shadow: 0 6px 0 #cc2200, 0 15px 30px rgba(0,0,0,0.4);
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: pointer;
            text-transform: uppercase;
        }
        .kart-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #cc2200, 0 5px 10px rgba(0,0,0,0.3);
        }

        .glass-panel {
            background: var(--glass-bg);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .q-tag { background: var(--kart-blue); color: white; padding: 3px 12px; border-radius: 12px; font-size: 11px; font-weight: 800; }
        .q-text { font-size: 20px; font-weight: 800; color: #2d3748; text-align: center; margin-bottom: 24px; line-height: 1.4; }

        .racer-grid { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; }
        .racer-card {
            background: white; border-radius: 16px; padding: 12px;
            display: flex; align-items: center; cursor: pointer;
            border: 2px solid #eee; box-shadow: 0 4px 0 #ddd;
            transition: all 0.2s;
        }
        .racer-card:hover, .racer-card.selected {
            background: #fff9c4; border-color: var(--kart-yellow); transform: translateY(-2px);
            box-shadow: 0 6px 0 #fbc02d;
        }
        .racer-img-box {
            width: 48px; height: 48px; border-radius: 50%; background: #f0f0f0; margin-right: 15px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
        .racer-info h4 { font-weight: 800; color: #333; font-size: 15px; }
        .racer-info p { font-size: 11px; color: #777; }

        .option-btn {
            display: block; width: 100%; text-align: left;
            background: white; border: 2px solid #eee;
            padding: 14px; margin-bottom: 10px;
            font-size: 15px; font-weight: 700; border-radius: 12px;
            box-shadow: 0 4px 0 #ddd; transition: 0.1s;
            position: relative;
        }
        .option-btn.selected { background: #fff9c4; border-color: var(--kart-yellow); box-shadow: 0 4px 0 #fbc02d; }
        .option-btn.selected::after { content: 'ğŸ'; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .option-btn:active { transform: translateY(4px); box-shadow: none; }

        .nav-btn {
            flex: 1; padding: 14px; text-align: center; border-radius: 16px;
            font-weight: 800; font-size: 16px; transition: transform 0.1s;
        }
        .btn-back { background: #f1f5f9; color: #64748b; box-shadow: 0 4px 0 #cbd5e1; }
        .btn-next { background: var(--kart-green); color: white; box-shadow: 0 4px 0 #16a34a; }
        .nav-btn:active { transform: translateY(4px); box-shadow: none; }

        .kart-input {
            width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 16px;
            font-size: 18px; font-weight: bold; text-align: center; outline: none; background: #fff;
        }
        .input-label { font-size: 13px; font-weight: 700; color: #555; margin-bottom: 6px; display: block; text-align: center; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        .chart-box { position: relative; height: 250px; width: 100%; margin: 20px 0; }
        
        .entry-no-badge {
            background: #000; color: #fff; font-family: 'Fredoka', sans-serif;
            font-weight: 900; padding: 4px 10px; border-radius: 8px; border: 2px solid #fff;
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 20;
        }
    </style>
</head>
<body>

<div class="kart-frame">
    <div class="road-bg"></div>

    <!-- HUD -->
    <div class="hud">
        <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-gray-100">LAP</span>
            <span class="lap-badge" id="stepIndicator">START</span>
        </div>
        <div class="flex items-center gap-2">
            <i class="ph-fill ph-coin text-yellow-300"></i>
            <span class="font-black text-white" id="scoreDisplay">000</span>
        </div>
    </div>

    <!-- 1. Intro -->
    <div id="screen-intro" class="scene center-scene fade-in">
        <div class="text-center">
            <div class="relative mb-6">
                <i class="ph-duotone ph-steering-wheel text-8xl text-white drop-shadow-lg"></i>
            </div>
            <h1 class="intro-logo">SUPER<br>SALES KART</h1>
            <div class="logo-sub">MARKET VALUE GRAND PRIX</div>
        </div>
        <button class="kart-btn" onclick="goToRacerSelect()">RACE START!</button>
    </div>

    <!-- 2. Racer Select -->
    <div id="screen-racer" class="scene hidden fade-in">
        <div class="glass-panel">
            <div class="q-header">
                <span class="q-tag">SELECT PLAYER</span>
                <span class="text-xs text-gray-400 font-bold">1 / 18</span>
            </div>
            <p class="q-text">1. ë‹¹ì‹ ì˜ ì˜ì—… ìŠ¤íƒ€ì¼ê³¼<br>ê°€ì¥ ë‹®ì€ ìºë¦­í„°ëŠ”?</p>
            <div id="racer-list" class="racer-grid"></div>
        </div>
    </div>

    <!-- 3. Dynamic Questions -->
    <div id="screen-q" class="scene hidden fade-in">
        <div class="glass-panel">
            <div class="q-header">
                <span class="q-tag" id="q-category">DRIVING</span>
                <span class="text-xs text-gray-400 font-bold" id="q-progress">2 / 18</span>
            </div>
            <p class="q-text" id="q-desc">...</p>
            <div id="area-choice" class="flex flex-col"></div>
            <div id="area-input" class="hidden"></div>
        </div>
        <div class="flex gap-3 w-full max-w-[400px] mt-2">
            <button class="nav-btn btn-back w-1/3" onclick="prevStep()">BACK</button>
            <button class="nav-btn btn-next w-2/3" onclick="handleNext()">NEXT â–¶</button>
        </div>
    </div>

    <!-- 4. Result -->
    <div id="screen-result" class="scene hidden fade-in" style="padding-top:40px;">
        <div class="glass-panel text-center relative">
            <!-- Entry Number Badge -->
            <div class="entry-no-badge" id="res-entry-box" style="display:none;">
                PLAYER NO.<span id="res-entry-no">---</span>
            </div>

            <div class="w-20 h-20 bg-white rounded-full mx-auto -mt-16 border-4 border-yellow-400 flex items-center justify-center text-4xl shadow-lg mb-4">
                <span id="res-icon">ğŸ†</span>
            </div>
            <h2 class="text-2xl font-black text-gray-800 mb-1">FINISH!</h2>
            <p class="text-xs text-gray-500 font-bold mb-6 uppercase">Course Clear â€¢ New Record</p>

            <div class="flex justify-center items-center gap-4 bg-gray-50 p-3 rounded-2xl border border-gray-100 mb-6">
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 font-bold">RACER</p>
                    <p class="text-base font-black text-gray-800" id="res-name">---</p>
                </div>
                <div class="h-8 w-px bg-gray-300"></div>
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 font-bold">TYPE</p>
                    <p class="text-base font-black text-blue-500" id="res-role">---</p>
                </div>
            </div>

            <div class="bg-gradient-to-br from-red-50 to-orange-50 p-4 rounded-2xl border-2 border-white shadow-inner text-center mb-6">
                <p class="text-[10px] font-bold text-red-500 tracking-widest mb-1">TOTAL BOUNTY</p>
                <div class="text-3xl font-black text-gray-800">
                    <span id="finalPrice">0</span> <span class="text-lg text-gray-500">ë§Œì›</span>
                </div>
                <div class="mt-2 text-[10px] font-bold text-gray-500">
                    ì—°ë´‰ ëŒ€ë¹„ <span class="text-red-500" id="finalPct">0</span>% UP ğŸš€
                </div>
            </div>

            <div class="chart-box"><canvas id="radarChart"></canvas></div>
            
            <div class="bg-gray-800 p-4 rounded-2xl text-[11px] text-gray-300 leading-relaxed text-left">
                <strong class="text-yellow-400 block mb-1">ğŸ“¢ PIT CREW'S ADVICE:</strong>
                <span id="aiAdvice">...</span>
            </div>
        </div>
        <button class="kart-btn w-full text-lg mt-4" id="btn-share" onclick="shareLink()">ê²°ê³¼ ê³µìœ í•˜ê¸°</button>
    </div>
</div>

<script>
    const BACKEND_URL = 'http://localhost:3000/api/submit'; 

    const racerList = [
        { id: 'mario', name: 'ë§ˆë¦¬ì˜¤ (ë¦¬ë”í˜•)', desc: 'íŒ€ì„ ì´ë„ëŠ” íƒì›”í•œ ì¡°ì§ ê´€ë¦¬ì', icon: 'Cap' },
        { id: 'luigi', name: 'ë£¨ì´ì§€ (ë°¸ëŸ°ìŠ¤)', desc: 'ê¸°ë³¸ê¸°ê°€ íƒ„íƒ„í•œ íŒ”ë°©ë¯¸ì¸ ì˜ì—…ì', icon: 'Luigi' },
        { id: 'bowser', name: 'ì¿ í¼ (íŒŒì›Œí˜•)', desc: 'í´ë¡œì§• ë§ˆìŠ¤í„° (ê²°ì •ë ¥)', icon: 'Bowser' },
        { id: 'yoshi', name: 'ìš”ì‹œ (ìŠ¤í”¼ë“œ)', desc: 'ì „í™” ì—°ê²°ì˜ ì‹ , TA ê³ ìˆ˜', icon: 'Yoshi' },
        { id: 'toad', name: 'í‚¤ë…¸í”¼ì˜¤ (ì„œí¬íŠ¸)', desc: 'ì¡°ì§ì˜ í•µì‹¬ ì¡°ë ¥ì', icon: 'Toad' }
    ];

    const questions = [
        { id: 'rank', title: 'í˜„ì¬ ì§ê¸‰', text: 'í˜„ì¬ ì¡°ì§ì—ì„œì˜ ìœ„ì¹˜ëŠ”?', type: 'choice', opts: [{l:'íŒ€ì› (FA/FC)',v:'íŒ€ì›'}, {l:'íŒ€ì¥ (SM/FM)',v:'íŒ€ì¥'}, {l:'ì§€ì ì¥ (BM)',v:'ì§€ì ì¥'}, {l:'ë³¸ë¶€ì¥/ì„ì›',v:'ë³¸ë¶€ì¥'}] },
        { id: 'team', title: 'ì¡°ì§ ê·œëª¨', text: 'í˜„ì¬ ì‚°í•˜ íŒ€ì›ì€ ëª‡ ëª…ì¸ê°€ìš”?', type: 'input', inputs: [{id:'team_size', p:'0', label:'ì¸ì› (ëª…)', type:'number'}] },
        { id: 'recruit', title: 'ë¦¬í¬ë£¨íŒ…', text: '1ë…„ì— ëª‡ ëª… ì •ë„ë¥¼ ì§ì ‘ ì±„ìš©í•˜ë‚˜ìš”?', type: 'input', inputs: [{id:'recruit_avg', p:'0', label:'ì—°ê°„ ë„ì… (ëª…)', type:'number'}] },
        { id: 'license', title: 'ë³´ìœ  ìê²©', text: 'ë³´ìœ í•œ ë©´í—ˆ(ìê²©)ë¥¼ ì„ íƒí•˜ì„¸ìš”.', type: 'choice', opts: [{l:'ê¸°ë³¸ ìê²©', v:'ê¸°ë³¸'}, {l:'+ ë³€ì•¡ ë©´í—ˆ', v:'ë³€ì•¡'}, {l:'+ ê¸ˆìœµ ì „ë¬¸ ìê²©', v:'ê¸ˆìœµìê²©'}] },
        { id: 'career', title: 'ë³´í—˜ ê²½ë ¥', text: 'ì´ ì˜ì—… ê²½ë ¥ì€ ì–´ëŠ ì •ë„ì¸ê°€ìš”?', type: 'choice', opts: [{l:'1ë…„ ë¯¸ë§Œ',v:'1ë…„ë¯¸ë§Œ'}, {l:'1~3ë…„',v:'1~3ë…„'}, {l:'3~5ë…„',v:'3~5ë…„'}, {l:'5~10ë…„',v:'5~10ë…„'}, {l:'10ë…„ ì´ìƒ',v:'10ë…„ì´ìƒ'}] },
        { id: 'income', title: 'ì›ì²œ ì†Œë“', text: 'ì‘ë…„ ì›ì²œì§•ìˆ˜ ì†Œë“ì€ ì–¼ë§ˆì¸ê°€ìš”?', type: 'input', inputs: [{id:'income', p:'5000', label:'ê¸ˆì•¡ (ë§Œì›)', type:'number'}] },
        { id: 'history', title: 'ì´ì§ íšŸìˆ˜', text: 'ìµœê·¼ 3ë…„ ë‚´ ë³´í—˜ì‚¬ ì´ì§ íšŸìˆ˜ëŠ”?', type: 'choice', opts: [{l:'ì—†ìŒ',v:0}, {l:'1íšŒ',v:1}, {l:'2íšŒ',v:2}, {l:'3íšŒ ì´ìƒ',v:3}] },
        { id: 'style', title: 'ì˜ì—… ë°©ì‹', text: 'ì£¼ë¡œ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì˜ì—…í•˜ë‚˜ìš”?', type: 'choice', opts: [{l:'ê°œì²™ ì˜ì—…',v:'ê°œì²™'}, {l:'ì§€ì¸/ì†Œê°œ ì˜ì—…',v:'ì§€ì¸'}, {l:'DB ì˜ì—…',v:'DB'}, {l:'ì´ê´€ê³ ê° ì˜ì—…',v:'ì´ê´€'}, {l:'ê¸°íƒ€ (SNS ë“±)',v:'ê¸°íƒ€'}] },
        { id: 'client', title: 'ì£¼ë ¥ ê³ ê°', text: 'ì£¼ë ¥ìœ¼ë¡œ ë§Œë‚˜ëŠ” ê³ ê°ì¸µì€?', type: 'choice', opts: [{l:'ì§ì¥ì¸ (2030)',v:'ì§ì¥ì¸'}, {l:'ì£¼ë¶€ (4050)',v:'ì£¼ë¶€'}, {l:'ì‹œë‹ˆì–´ (60ëŒ€+)',v:'ì‹œë‹ˆì–´'}, {l:'ìì˜ì—…ì',v:'ìì˜ì—…ì'}, {l:'ë²•ì¸/ì „ë¬¸ì§',v:'ë²•ì¸'}] },
        { id: 'port', title: 'ì£¼ë ¥ ìƒí’ˆ', text: 'ê°€ì¥ ìì‹ ìˆëŠ” ìƒí’ˆêµ°ì€?', type: 'choice', opts: [{l:'ë³´ì¥ì„±',v:'ë³´ì¥ì„±'}, {l:'ì €ì¶•ì„±',v:'ì €ì¶•ì„±'}, {l:'ìë™ì°¨/í™”ì¬',v:'ìë™ì°¨'}, {l:'ë³µí•©',v:'ë³µí•©'}] },
        { id: 'w', title: 'í™œë™ ê¸°ë¡', text: 'ì—°ì† ì²­ì•½(W) ê¸°ë¡ì´ ìˆë‚˜ìš”?', type: 'choice', opts: [{l:'ì—†ìŒ',v:'ì—†ìŒ'}, {l:'1W 20ì£¼+',v:'1W'}, {l:'2W 20ì£¼+',v:'2W'}, {l:'3W 50ì£¼+',v:'3W'}] },
        { id: 'perf', title: 'í‰ê·  ì‹¤ì ', text: 'ì›” í‰ê·  ì‹¤ì  ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', type: 'input', inputs: [{id:'count', p:'4.5', label:'ì›” ê±´ìˆ˜', type:'number'}, {id:'premium', p:'50', label:'ì›” í‰ê·  ë‚©ì…ë³´í—˜ë£Œ(ë§Œ)', type:'number'}] },
        { id: 'mdrt', title: 'MDRT', text: 'MDRT ê²½í—˜ì´ ìˆë‚˜ìš”?', type: 'choice', opts: [{l:'ì—†ìŒ',v:'ì—†ìŒ'}, {l:'MDRT',v:'MDRT'}, {l:'COT',v:'COT'}, {l:'TOT',v:'TOT'}] },
        { id: 'mdrt_cnt', title: 'MDRT íšŸìˆ˜', text: 'ëª‡ ë²ˆì´ë‚˜ ë‹¬ì„±í–ˆë‚˜ìš”?', type: 'choice', opts: [{l:'1íšŒ',v:1},{l:'2íšŒ',v:2},{l:'3~4íšŒ',v:3},{l:'5íšŒ ì´ìƒ',v:5}], condition: (data) => data.mdrt !== 'ì—†ìŒ' },
        { id: 'qual', title: 'ìœ ì§€ìœ¨', text: 'ê³„ì•½ ìœ ì§€ìœ¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', type: 'input', inputs: [{id:'p13', p:'95', label:'13íšŒì°¨ (%)', type:'number'}, {id:'p25', p:'85', label:'25íšŒì°¨ (%)', type:'number'}] },
        { id: 'needs', title: 'í˜„ì¬ ë¶ˆë§Œ', text: 'í˜„ì¬ ì¡°ì§ì— ë¶ˆë§Œì´ ìˆë‹¤ë©´ ì–´ë–¤ ì ì¸ê°€ìš”?', type: 'choice', opts: [{l:'DB ì§€ì› ë¶€ì¡±',v:'DBë¶€ì¡±'}, {l:'ìˆ˜ìˆ˜ë£Œ/ë³´ìƒ ì²´ê³„',v:'ìˆ˜ìˆ˜ë£Œ'}, {l:'êµìœ¡ ì‹œìŠ¤í…œ ë¶€ì¬',v:'êµìœ¡ë¶€ì¬'}, {l:'ì¡°ì§ ë¬¸í™”/ë¹„ì „',v:'ì¡°ì§ë¬¸í™”'}, {l:'ë¶ˆë§Œ ì—†ìŒ',v:'ë¶ˆë§Œì—†ìŒ'}] },
        { id: 'info', title: 'ê¸°ë³¸ ì •ë³´', text: 'ë¦¬í¬íŠ¸ ë°œê¸‰ì„ ìœ„í•œ ì •ë³´ ì…ë ¥', type: 'input', inputs: [{id:'userName', p:'í™ê¸¸ë™', label:'ì´ë¦„'}, {id:'region', p:'ì„œìš¸', label:'ì§€ì—­'}] },
        { id: 'gender', title: 'ì„±ë³„', text: 'ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', type: 'gender' },
        { id: 'contact', title: 'ì—°ë½ì²˜', text: 'ê²°ê³¼ ìˆ˜ì‹  ë° ì €ì¥ì„ ìœ„í•œ ì—°ë½ì²˜', type: 'phone' }
    ];

    let userData = {};
    let currentStepIdx = -1;
    let activeSteps = [];
    let radarChart = null;

    function showScreen(id) {
        document.querySelectorAll('.scene').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function goToRacerSelect() {
        showScreen('screen-racer');
        const list = document.getElementById('racer-list');
        list.innerHTML = '';
        racerList.forEach(r => {
            const el = document.createElement('div');
            el.className = 'racer-card';
            el.innerHTML = `
                <div class="racer-img-box">${getEmoji(r.id)}</div>
                <div class="racer-info"><h4>${r.name}</h4><p>${r.desc}</p></div>
            `;
            el.onclick = () => { userData['racer'] = r; startRace(); };
            list.appendChild(el);
        });
    }

    function getEmoji(id) {
        const map = { mario:'ğŸ§¢', luigi:'ğŸŸ¢', bowser:'ğŸ”¥', yoshi:'ğŸ¥š', toad:'ğŸ„' };
        return map[id];
    }

    function startRace() {
        activeSteps = [...questions];
        currentStepIdx = 0;
        showScreen('screen-q');
        renderQuestion();
    }

    function renderQuestion() {
        while (currentStepIdx < activeSteps.length) {
            const q = activeSteps[currentStepIdx];
            if (q.condition && !q.condition(userData)) { currentStepIdx++; } else { break; }
        }
        if (currentStepIdx >= activeSteps.length) { finishRace(); return; }

        const q = activeSteps[currentStepIdx];
        const displayNum = currentStepIdx + 2; 
        
        document.getElementById('stepIndicator').innerText = `LAP ${displayNum}`;
        document.getElementById('q-progress').innerText = `${displayNum} / 18`;
        document.getElementById('q-desc').innerText = `${displayNum}. ${q.text}`;

        const cArea = document.getElementById('area-choice');
        const iArea = document.getElementById('area-input');
        cArea.innerHTML = ''; iArea.innerHTML = '';
        cArea.classList.add('hidden'); iArea.classList.add('hidden');

        if (q.type === 'choice') {
            cArea.classList.remove('hidden');
            q.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                if(userData[q.id] === opt.v) btn.classList.add('selected');
                btn.innerText = opt.l;
                btn.onclick = () => { userData[q.id] = opt.v; renderQuestion(); };
                cArea.appendChild(btn);
            });
        } else if (q.type === 'gender') {
            cArea.classList.remove('hidden');
            const row = document.createElement('div'); 
            row.className = "flex gap-3 w-full";
            ['ë‚¨ì„±', 'ì—¬ì„±'].forEach(g => {
                const btn = document.createElement('button');
                btn.className = 'option-btn text-center flex-1';
                if(userData['gender'] === g) btn.classList.add('selected');
                btn.innerText = g;
                btn.onclick = () => { 
                    userData['gender'] = g;
                    row.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };
                row.appendChild(btn);
            });
            cArea.appendChild(row);
        } else if (q.type === 'phone') {
            iArea.classList.remove('hidden');
            iArea.innerHTML = `
                <div class="flex gap-2 items-center mb-4">
                    <input type="text" value="010" readonly class="kart-input w-1/4 bg-gray-100 text-gray-400">
                    <input type="tel" id="p_mid" class="kart-input w-1/3" maxlength="4" placeholder="1234">
                    <input type="tel" id="p_end" class="kart-input w-1/3" maxlength="4" placeholder="5678">
                </div>
                <div class="bg-gray-50 p-3 rounded-xl text-[10px] text-gray-500 border border-gray-200">
                    <label class="flex items-center gap-2 cursor-pointer font-bold"><input type="checkbox" id="agree1" class="w-4 h-4" checked> [í•„ìˆ˜] ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</label>
                    <label class="flex items-center gap-2 cursor-pointer font-bold mt-2"><input type="checkbox" id="agree2" class="w-4 h-4" checked> [í•„ìˆ˜] ì œ3ì ì •ë³´ ì œê³µ ë™ì˜</label>
                </div>
            `;
        } else {
            iArea.classList.remove('hidden');
            q.inputs.forEach(inp => {
                const label = document.createElement('label'); label.className = 'input-label'; label.innerText = inp.label;
                iArea.appendChild(label);
                const input = document.createElement('input'); input.id = inp.id; input.type = inp.type || 'text';
                input.className = 'kart-input mb-4'; input.placeholder = inp.p;
                if(userData[inp.id]) input.value = userData[inp.id];
                iArea.appendChild(input);
            });
        }
    }

    function handleNext() {
        const q = activeSteps[currentStepIdx];
        if (q.type === 'choice' || q.type === 'gender') {
            const key = q.type === 'gender' ? 'gender' : q.id;
            if(userData[key] === undefined) { alert('í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
        } else if (q.type === 'phone') {
            const m = document.getElementById('p_mid').value, e = document.getElementById('p_end').value;
            const a1 = document.getElementById('agree1').checked, a2 = document.getElementById('agree2').checked;
            if(m.length < 4 || e.length < 4) { alert("ì—°ë½ì²˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); return; }
            if(!a1 || !a2) { alert("ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”."); return; }
            userData['phone'] = `010-${m}-${e}`;
        } else {
            let valid = true;
            q.inputs.forEach(inp => {
                const el = document.getElementById(inp.id);
                if(!el.value) { el.style.borderColor="red"; valid=false; }
                else userData[inp.id] = el.value;
            });
            if(!valid) return;
        }
        currentStepIdx++; renderQuestion();
    }

    function prevStep() { if(currentStepIdx > 0) { currentStepIdx--; renderQuestion(); } else { goToRacerSelect(); } }

    async function finishRace() {
        const income = parseInt(userData['income']) || 5000;
        let mult = 1.0;
        
        const prem = parseInt(userData['premium']||0);
        const p13 = parseInt(userData['p13']||0);
        const p25 = parseInt(userData['p25']||0);
        const s_prod = prem >= 100 ? 10 : (prem >= 70 ? 8 : (prem >= 50 ? 6 : 4));
        const s_eff = (prem / (parseFloat(userData['count'])||1)) >= 15 ? 10 : 7;
        const s_qual = ((p13 >= 95 ? 10 : 7) + (p25 >= 85 ? 10 : 7)) / 2;
        const s_exp = (userData['mdrt'] !== 'ì—†ìŒ' ? 5 : 0) + (userData['license'] !== 'ê¸°ë³¸' ? 3 : 1);
        const s_lead = parseInt(userData['team_size']||0) >= 5 ? 10 : 6;

        mult += (s_prod + s_qual + s_eff + s_exp + s_lead) * 0.015;
        let finalPriceVal = Math.round(income * mult * 0.6); 
        let finalPctVal = Math.round((finalPriceVal/income)*100);

        showScreen('screen-result');
        document.getElementById('res-name').innerText = userData['userName'];
        document.getElementById('res-role').innerText = userData['racer'].name;
        document.getElementById('res-icon').innerText = getEmoji(userData['racer'].id);

        let current = 0;
        const timer = setInterval(() => {
            current += Math.ceil(finalPriceVal / 30);
            if(current >= finalPriceVal) { current = finalPriceVal; clearInterval(timer); }
            document.getElementById('finalPrice').innerText = current.toLocaleString();
        }, 30);
        document.getElementById('finalPct').innerText = finalPctVal;
        document.getElementById('aiAdvice').innerText = "ë‹¹ì‹ ì€ ì„œí‚·ì˜ ì§€ë°°ì! í˜„ì¬ ëª¸ê°’ë³´ë‹¤ í›¨ì”¬ ë” ë†’ì€ ê°€ì¹˜ë¥¼ ì¸ì •ë°›ì„ ìê²©ì´ ì¶©ë¶„í•©ë‹ˆë‹¤.";

        renderRadarChart([s_prod, s_eff, s_qual, s_exp, s_lead]);

        // --- ë°±ì—”ë“œ ë°ì´í„° ì „ì†¡ ë° ìˆœë²ˆ ë°›ê¸° ---
        const payload = {
            timestamp: new Date().toLocaleString(),
            name: userData['userName'],
            phone: userData['phone'],
            gender: userData['gender'],
            region: userData['region'],
            rank: userData['rank'],
            team_size: userData['team_size'],
            recruit_avg: userData['recruit_avg'],
            career: userData['career'],
            income: userData['income'],
            history: userData['history'],
            style: userData['style'],
            client: userData['client'],
            portfolio: userData['port'],
            continuance_w: userData['w'],
            perf_count: userData['count'],
            perf_premium: userData['premium'],
            mdrt: userData['mdrt'],
            p13: userData['p13'],
            p25: userData['p25'],
            needs: userData['needs'],
            final_bounty: finalPriceVal,
            racer_type: userData['racer'].name,
            stats: { s_prod, s_eff, s_qual, s_exp, s_lead }
        };

        try {
            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const res = await response.json();
            if (res.success) { 
                // ì„œë²„ì—ì„œ ë°›ì€ ìˆœë²ˆ í‘œì‹œ
                document.getElementById('res-entry-box').style.display = 'block';
                document.getElementById('res-entry-no').innerText = res.entryNo.toString().padStart(3, '0');
                document.getElementById('scoreDisplay').innerText = res.entryNo;
            }
        } catch (err) {
            console.error('Failed to send data to backend:', err);
        }
    }

    function renderRadarChart(data) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['ìƒì‚°ì„±', 'íš¨ìœ¨ì„±', 'ìœ ì§€ìœ¨', 'ì „ë¬¸ì„±', 'ë¦¬ë”ì‹­'],
                datasets: [{
                    data: data, backgroundColor: 'rgba(0, 157, 253, 0.2)', 
                    borderColor: '#009dfd', pointBackgroundColor: '#fff', borderWidth: 2
                }]
            },
            options: {
                scales: { r: { min: 0, max: 10, ticks: { display: false }, grid: { color: 'rgba(0,0,0,0.1)' }, pointLabels: { font: { size: 10, weight: 'bold' } } } },
                plugins: { legend: { display: false } }, maintainAspectRatio: false
            }
        });
    }

    function shareLink() { alert("ê²°ê³¼ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); }
</script>
</body>
</html>
